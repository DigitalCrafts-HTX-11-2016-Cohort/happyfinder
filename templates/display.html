{% extends "layout.html" %}
{% block apikey %}
    <script src="https://maps.google.com/maps/api/js?key={{ apikey }}"></script>
{% endblock %}
{% block body %}
    <body onload="locate()">
        <div class="row div-row">
            <div class="col-sm-9 col-xs-12" id="map-canvas"></div>
            <div class="col-sm-3 col-xs-12" id="infowindow">
                <div>
                    {% for place in place_list %}
                        <a href="javascript:google.maps.event.trigger(gmarkers['{{ place.formatted_address[0] }}'],'click');">
                            <div class="place_details">
                                <table class="place_descriptions" style="border: 1px solid dimgray; width: 100%">
                                    <tr>
                                        <th colspan="2" style="text-align: center"><a
                                                href="/details/{{ place.location_id }}"><h4
                                                class="place_descriptions">{{ place.name }}</h4></a></th>
                                    </tr>
                                    <tr>
                                        <th colspan="2" style="text-align: center; border-bottom: 3px solid dimgray"><h5
                                                class="place_descriptions">{{ place.price_level * '$' }} -
                                            Rating: {{ place.rating }}</h5></th>
                                    </tr>
                                    <tr>
                                        <td style="width: 100%">
                                            <table style="width: 100%">
                                                <tr style="display: none">
                                                    <th style="display: none"></th>
                                                </tr>
                                                <tr>
                                                    <td style="width: 100%">
                                                        {% for day in place.happy_hour %}
                                                            <table style="width: 100%; border-right:1px solid dimgray;">
                                                                <tr style="display: none">
                                                                    <th style="display: none"></th>
                                                                    <th style="display: none"></th>
                                                                </tr>
                                                                <tr>
                                                                    <td style="text-align: center; width: 50%; font-weight: bold">
                                                                        {{ day.day_string }}
                                                                    </td>
                                                                    <td style="text-align: center; width: 50%">
                                                                        {{ day.start_time.strftime("%I:%M %p") }}
                                                                        - {{ day.end_time.strftime("%I:%M %p") }}
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                        {% endfor %}
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>

    <script>
        var im = 'https://www.robotwoods.com/dev/misc/bluecircle.png';


        function locate() {
            navigator.geolocation.getCurrentPosition(initialize, fail);
        }

        function initialize(position) {
            var myLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            var map = new google.maps.Map(document.getElementById('map-canvas'), {
                zoom: 12,
                center: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            var infowindow = new google.maps.InfoWindow();

            function createMarker(latlng, html) {
                var marker = new google.maps.Marker({
                    position: latlng,
                    map: map
                });
                google.maps.event.addListener(marker, 'click', function () {
                    infowindow.setContent(html);
                    infowindow.open(map, marker);
                });
                return marker;
            }

            function userMarker() {
                var marker = new google.maps.Marker({
                    position: myLatLng,
                    icon: im,
                    map: map
                });
                google.maps.event.addListener(marker, 'click', function () {
                    infowindow.setContent("My Location");
                    infowindow.open(map, marker);
                });
                return marker;
            }

            userMarker();
            gmarkers = [];
            {% for place in place_list %}
                var form_add = "{{ place.formatted_address[0] }}";
                var name = "{{ place.name }}";
                var lat = parseFloat({{ place.lat }});
                var lng = parseFloat({{ place.lng }});

                gmarkers[form_add] = createMarker(new google.maps.LatLng(lat, lng), name + "<br>" + form_add);
            {% endfor %}
        }

        google.maps.event.addDomListener(window, 'load', initialize);

        function fail() {
            alert('navigator.geolocation failed, may not be supported');
        }
    </script>
    </body>
{% endblock %}
